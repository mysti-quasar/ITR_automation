<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TaxAI Pro 2025</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Accordion Animation */
        #itr-content { transition: all 0.3s ease-in-out; }
        .rotate-180 { transform: rotate(180deg); }
        
        /* Robot Shape Specific CSS */
        .robot-container {
            border-radius: 40px; /* Round shape */
            border: 4px solid #e0e7ff; /* Outer glow effect */
            overflow: hidden;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .robot-head {
            background: linear-gradient(135deg, #4f46e5 0%, #3730a3 100%);
            position: relative;
        }
        /* Antenna Effect */
        .robot-antenna {
            width: 4px;
            height: 15px;
            background-color: #3730a3;
            margin: 0 auto;
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
        }
        .robot-antenna::after {
            content: '';
            width: 10px;
            height: 10px;
            background-color: #ef4444; /* Red light */
            border-radius: 50%;
            position: absolute;
            top: -8px;
            left: -3px;
            animation: blink 2s infinite;
        }
        @keyframes blink { 50% { opacity: 0.5; } }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 font-sans min-h-screen flex flex-col">

    <!-- Navbar -->
    <nav class="bg-white shadow border-b p-4 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-2 text-indigo-900 font-bold text-xl">
                <i class="fa-solid fa-calculator"></i> TaxAI <span class="text-indigo-500">Pro</span>
            </div>
            <span class="text-xs bg-indigo-100 text-indigo-800 px-2 py-1 rounded border border-indigo-200">FY 2025-26</span>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="flex-1 max-w-7xl mx-auto p-4 w-full grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        <!-- ========================== -->
        <!-- LEFT PANEL (Span 2): Tax Engine & ITR Form -->
        <!-- ========================== -->
        <div class="lg:col-span-2 space-y-6">
            
            <!-- 1. Unified Tax Engine (Previous Style) -->
            <div class="bg-white p-6 rounded-2xl shadow-md border border-gray-200">
                <h2 class="text-xl font-bold mb-4 text-gray-800 border-b pb-3 flex items-center gap-2">
                    <span class="bg-green-100 text-green-700 p-2 rounded-lg"><i class="fa-solid fa-file-invoice-dollar"></i></span>
                    Tax Calculation Engine
                </h2>

                <!-- Upload & Manual Entry Grid -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <!-- Upload -->
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-2">1. Upload Statement</label>
                        <div class="border-2 border-dashed border-indigo-200 bg-indigo-50/50 p-4 rounded-xl relative hover:bg-indigo-50 transition text-center h-28 flex flex-col justify-center items-center group">
                            <input type="file" id="file-input" class="absolute inset-0 opacity-0 cursor-pointer w-full h-full z-10">
                            <i class="fa-solid fa-cloud-arrow-up text-2xl text-indigo-400 group-hover:text-indigo-600 transition"></i>
                            <p class="text-indigo-600 font-bold text-sm mt-1">Click to Upload PDF</p>
                            <p id="file-name" class="text-xs text-green-600 mt-1 truncate max-w-[180px] font-medium"></p>
                        </div>
                    </div>
                    
                    <!-- Manual Entry -->
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-2">2. Add Manual Entry</label>
                        <div class="flex flex-col gap-2 bg-gray-50 p-3 rounded-xl border">
                            <input type="text" id="m-desc" placeholder="Desc (e.g. Cash Income)" class="border p-2 rounded-lg text-sm w-full outline-none focus:border-indigo-500">
                            <div class="flex gap-2">
                                <input type="number" id="m-amt" placeholder="â‚¹ Amount" class="border p-2 rounded-lg text-sm w-24 outline-none focus:border-indigo-500">
                                <select id="m-cat" class="border p-2 rounded-lg text-sm flex-1 outline-none bg-white">
                                    <option value="expense">Expense</option>
                                    <option value="income">Income</option>
                                    <option value="80c">80C</option>
                                    <option value="80d">80D</option>
                                </select>
                                <button onclick="addToLocalList()" class="bg-indigo-600 text-white px-3 rounded-lg hover:bg-indigo-800 transition shadow"><i class="fa-solid fa-plus"></i></button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Staging Table -->
                <div id="staging-area" class="hidden mb-6 bg-yellow-50 p-3 rounded-lg border border-yellow-200">
                    <h3 class="text-xs font-bold text-yellow-700 uppercase mb-2">Entries Waiting for Analysis:</h3>
                    <ul id="staging-body" class="text-sm space-y-2"></ul>
                </div>

                <!-- Main Action Button -->
                <button onclick="analyzeCombined()" id="main-btn" class="w-full bg-gradient-to-r from-green-500 to-green-700 hover:from-green-600 hover:to-green-800 text-white py-3.5 rounded-xl font-bold shadow-lg text-lg transition transform active:scale-95 flex justify-center items-center gap-2">
                    <i class="fa-solid fa-bolt"></i> Calculate Tax Now
                </button>
            </div>

            <!-- 2. ITR Finder (Collapsible) -->
            <div class="bg-white rounded-2xl shadow-md border border-gray-200 overflow-hidden">
                <!-- Header (Click to Open) -->
                <div onclick="toggleITR()" class="p-4 bg-purple-50 cursor-pointer flex justify-between items-center hover:bg-purple-100 transition group">
                    <div class="flex items-center gap-3">
                        <div class="bg-purple-200 text-purple-700 w-8 h-8 rounded-full flex items-center justify-center">
                            <i class="fa-solid fa-magnifying-glass"></i>
                        </div>
                        <h2 class="font-bold text-purple-900">Know Your ITR Form</h2>
                    </div>
                    <i id="itr-icon" class="fa-solid fa-chevron-down text-purple-400 group-hover:text-purple-600 transition-transform duration-300"></i>
                </div>
                
                <!-- Content (Hidden) -->
                <div id="itr-content" class="hidden p-6 border-t bg-white">
                    <p class="text-xs text-gray-500 mb-4">Select applicable sources to get an AI recommendation:</p>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-3 text-sm mb-4">
                        <label class="flex gap-2 items-center p-2 border rounded hover:bg-gray-50 cursor-pointer"><input type="checkbox" class="itr-chk accent-purple-600" value="Salary"> Salary</label>
                        <label class="flex gap-2 items-center p-2 border rounded hover:bg-gray-50 cursor-pointer"><input type="checkbox" class="itr-chk accent-purple-600" value="Stocks/Capital Gains"> Stocks</label>
                        <label class="flex gap-2 items-center p-2 border rounded hover:bg-gray-50 cursor-pointer"><input type="checkbox" class="itr-chk accent-purple-600" value="Business"> Business</label>
                        <label class="flex gap-2 items-center p-2 border rounded hover:bg-gray-50 cursor-pointer"><input type="checkbox" class="itr-chk accent-purple-600" value="Income > 50L"> Income > 50L</label>
                        <label class="flex gap-2 items-center p-2 border rounded hover:bg-gray-50 cursor-pointer"><input type="checkbox" class="itr-chk accent-purple-600" value="Company / LLP / Trust"> Company/Trust</label>
                        <label class="flex gap-2 items-center p-2 border rounded hover:bg-gray-50 cursor-pointer"><input type="checkbox" class="itr-chk accent-purple-600" value="Director"> Director</label>
                    </div>
                    <div class="flex gap-2">
                        <textarea id="itr-note" rows="1" class="flex-1 border p-2 text-sm rounded-lg focus:ring-2 focus:ring-purple-500 outline-none" placeholder="Specific details (e.g. 44AD scheme)..."></textarea>
                        <button onclick="findITR()" id="itr-btn" class="bg-purple-600 text-white px-4 rounded-lg text-sm font-bold hover:bg-purple-700 shadow">Check</button>
                    </div>
                    <div id="itr-res" class="hidden mt-4 p-3 bg-purple-50 text-purple-900 text-sm border border-purple-200 rounded-lg"></div>
                </div>
            </div>

            <!-- RESULTS (Hidden initially) -->
            <div id="results" class="hidden space-y-6 animate-fade-in">
                <!-- Summary -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                    <div class="bg-white p-4 rounded-xl shadow border-b-4 border-gray-500">
                        <p class="text-xs text-gray-500 font-bold uppercase">Total Income</p>
                        <p class="font-bold text-2xl text-gray-800" id="res-inc">â‚¹0</p>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow border-b-4 border-blue-500">
                        <p class="text-xs text-gray-500 font-bold uppercase">New Regime Tax</p>
                        <p class="font-bold text-2xl text-blue-700" id="res-new">â‚¹0</p>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow border-b-4 border-orange-500">
                        <p class="text-xs text-gray-500 font-bold uppercase">Old Regime Tax</p>
                        <p class="font-bold text-2xl text-orange-700" id="res-old">â‚¹0</p>
                    </div>
                </div>
                
                <!-- Suggestions -->
                <div class="bg-gradient-to-r from-yellow-50 to-orange-50 p-6 rounded-xl shadow border border-orange-100">
                    <h3 class="font-bold text-gray-800 mb-3 flex items-center gap-2">
                        <i class="fa-solid fa-wand-magic-sparkles text-orange-500"></i> Smart Suggestions
                    </h3>
                    <ul id="sugg-list" class="list-disc pl-5 text-sm text-gray-700 space-y-2"></ul>
                </div>

                <!-- Footer Actions -->
                <div class="flex justify-between items-center">
                    <details class="text-xs text-gray-500">
                        <summary class="cursor-pointer hover:text-gray-700 underline">Show Raw JSON</summary>
                        <pre id="raw-json" class="mt-2 bg-gray-100 p-2 rounded overflow-x-auto max-w-lg"></pre>
                    </details>
                    <button onclick="downloadExcel()" class="bg-gray-800 hover:bg-black text-white px-5 py-2.5 rounded-lg font-bold shadow flex items-center gap-2 transition">
                        <i class="fa-solid fa-file-excel text-green-400"></i> Download Report
                    </button>
                </div>
            </div>

        </div>

        <!-- ========================== -->
        <!-- RIGHT PANEL (Span 1): ROBOT CA -->
        <!-- ========================== -->
        <div class="lg:col-span-1">
            <div class="sticky top-24">
                <!-- Antenna (Visual Decoration) -->
                <div class="relative w-full h-4">
                    <div class="robot-antenna"></div>
                </div>
                
                <!-- Robot Container -->
                <div class="robot-container bg-white flex flex-col h-[600px]">
                    <!-- Head -->
                    <div class="robot-head p-5 text-white flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <div class="bg-white/20 p-2 rounded-full backdrop-blur-sm">
                                <i class="fa-solid fa-robot text-2xl"></i>
                            </div>
                            <div>
                                <h3 class="font-bold text-lg leading-tight">CA Bot</h3>
                                <p class="text-[10px] opacity-80 uppercase tracking-wider">AI Tax Assistant</p>
                            </div>
                        </div>
                        <div class="w-3 h-3 bg-green-400 rounded-full shadow-[0_0_10px_#4ade80]"></div>
                    </div>

                    <!-- Chat Body -->
                    <div id="chat-box" class="flex-1 p-4 overflow-y-auto space-y-4 bg-slate-50 text-sm">
                        <!-- Welcome Msg -->
                        <div class="flex gap-3">
                            <div class="w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center shrink-0 border border-indigo-200">
                                <i class="fa-solid fa-robot text-indigo-600 text-xs"></i>
                            </div>
                            <div class="bg-white p-3 rounded-2xl rounded-tl-none shadow-sm border border-gray-100 text-gray-600">
                                ðŸ‘‹ Hello! I analyze your data contextually. Upload statement or add entries, then ask me anything!
                            </div>
                        </div>
                    </div>

                    <!-- Input Area -->
                    <div class="p-3 bg-white border-t">
                        <div class="relative">
                            <input type="text" id="chat-in" placeholder="Type your tax query..." 
                                class="w-full bg-gray-100 border-0 rounded-full py-3 pl-4 pr-12 text-sm focus:ring-2 focus:ring-indigo-500 focus:bg-white transition outline-none"
                                onkeypress="if(event.key === 'Enter') sendChat()">
                            <button onclick="sendChat()" class="absolute right-1 top-1 bg-indigo-600 text-white w-9 h-9 rounded-full hover:bg-indigo-700 flex items-center justify-center transition shadow-md">
                                <i class="fa-solid fa-paper-plane text-xs"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- JavaScript Logic (Same as before) -->
    <script>
        const API_URL = "http://127.0.0.1:8000";
        let manualEntriesList = [];

        function toggleITR() {
            const content = document.getElementById('itr-content');
            const icon = document.getElementById('itr-icon');
            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                icon.classList.add('rotate-180');
            } else {
                content.classList.add('hidden');
                icon.classList.remove('rotate-180');
            }
        }

        document.getElementById('file-input').onchange = (e) => {
            if(e.target.files[0]) document.getElementById('file-name').innerText = e.target.files[0].name;
        };

        function addToLocalList() {
            const desc = document.getElementById('m-desc').value.trim();
            const amt = parseFloat(document.getElementById('m-amt').value);
            const cat = document.getElementById('m-cat').value;

            if(!desc || isNaN(amt) || amt <= 0) return alert("Enter valid details");
            
            manualEntriesList.push({ description: desc, amount: amt, category: cat });
            updateStagingTable();
            document.getElementById('m-desc').value = "";
            document.getElementById('m-amt').value = "";
        }

        function updateStagingTable() {
            const area = document.getElementById('staging-area');
            const list = document.getElementById('staging-body');
            
            if(manualEntriesList.length > 0) area.classList.remove('hidden');
            else area.classList.add('hidden');

            list.innerHTML = manualEntriesList.map((item, i) => 
                `<li class="flex justify-between items-center bg-white p-2 rounded border border-yellow-100 shadow-sm">
                    <span class="font-medium text-gray-700">${item.description} <span class="text-[10px] bg-gray-200 text-gray-600 px-1 rounded uppercase ml-1">${item.category}</span></span>
                    <div class="flex items-center gap-3">
                        <span class="font-bold text-green-600">â‚¹${item.amount}</span>
                        <i onclick="removeEntry(${i})" class="fa-solid fa-trash text-red-400 cursor-pointer hover:text-red-600"></i>
                    </div>
                </li>`
            ).join('');
        }

        function removeEntry(index) {
            manualEntriesList.splice(index, 1);
            updateStagingTable();
        }

        async function analyzeCombined() {
            const file = document.getElementById('file-input').files[0];
            if (!file && manualEntriesList.length === 0) return alert("Please Upload file OR Add manual entries.");

            const btn = document.getElementById('main-btn');
            btn.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> Processing...`; btn.disabled = true;

            const fd = new FormData();
            if(file) fd.append("file", file);
            fd.append("manual_entries", JSON.stringify(manualEntriesList));

            try {
                const res = await fetch(`${API_URL}/analyze-combined`, { method: 'POST', body: fd });
                const d = await res.json();
                if(d.error) throw new Error(d.error);

                document.getElementById('results').classList.remove('hidden');
                document.getElementById('res-inc').innerText = "â‚¹" + d.analysis.total_income.toLocaleString();
                document.getElementById('res-new').innerText = "â‚¹" + d.estimated_tax.new_regime.toLocaleString();
                document.getElementById('res-old').innerText = "â‚¹" + d.estimated_tax.old_regime.toLocaleString();
                
                const ul = document.getElementById('sugg-list'); ul.innerHTML = "";
                d.ca_suggestions.forEach(s => ul.innerHTML += `<li>${s}</li>`);
                
                addBotMessage("âœ… Calculations Done! I have analyzed both your Bank PDF and Manual Entries.");
            } catch(e) { alert(e.message); }
            finally { btn.innerHTML = `<i class="fa-solid fa-bolt"></i> Calculate Tax Now`; btn.disabled = false; }
        }

        async function findITR() {
            const chk = Array.from(document.querySelectorAll('.itr-chk:checked')).map(c=>c.value);
            const note = document.getElementById('itr-note').value;
            if(!chk.length && !note) return alert("Select at least one option.");
            
            const btn = document.getElementById('itr-btn');
            btn.innerText = "..."; btn.disabled=true;
            
            try {
                const res = await fetch(API_URL+"/recommend-itr", {
                    method:'POST', headers:{'Content-Type':'application/json'},
                    body: JSON.stringify({history: `Selected: ${chk.join(',')}. Note: ${note}`})
                });
                const d = await res.json();
                const div = document.getElementById('itr-res');
                div.classList.remove('hidden');
                div.innerHTML = d.reply.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');
            } catch(e) { alert("Error connecting to AI"); }
            finally { btn.innerText = "Check"; btn.disabled=false; }
        }

        async function sendChat() {
            const inp = document.getElementById('chat-in');
            const txt = inp.value.trim();
            if(!txt) return;
            
            const box = document.getElementById('chat-box');
            box.innerHTML += `<div class="text-right"><span class="bg-indigo-600 text-white px-3 py-2 rounded-2xl rounded-tr-none inline-block shadow">${txt}</span></div>`;
            inp.value = ""; box.scrollTop = box.scrollHeight;

            try {
                const res = await fetch(API_URL+"/chat-with-ca", {
                    method:'POST', headers:{'Content-Type':'application/json'},
                    body: JSON.stringify({query: txt})
                });
                const d = await res.json();
                box.innerHTML += `<div class="flex gap-3"><div class="w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center shrink-0 border border-indigo-200"><i class="fa-solid fa-robot text-indigo-600 text-xs"></i></div><div class="bg-white p-3 rounded-2xl rounded-tl-none shadow-sm border border-gray-100 text-gray-700">${d.bot_reply.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>')}</div></div>`;
                box.scrollTop = box.scrollHeight;
            } catch(e) { box.innerHTML += `<div class="text-left text-red-500">Error</div>`; }
        }

         async function downloadExcel() {
            const btn = document.querySelector('button[onclick="downloadExcel()"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> Downloading...`;
            btn.disabled = true;

            try {
                // 1. Backend se file maangein
                const response = await fetch(API_URL + "/download-report");
                
                // 2. Agar koi data nahi hai to error dikhayein
                if (response.status === 400) {
                    alert("Please upload a statement or add entries first!");
                    return;
                }

                // 3. File (Blob) create karein
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                
                // 4. Temporary Link banakar click karein (CSV download ke liye)
                const a = document.createElement('a');
                a.href = url;
                a.download = "TaxAI_Report.csv";  // <--- Ye rahi wo line (.csv extension)
                document.body.appendChild(a);
                a.click();
                
                // Cleanup
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);

            } catch (e) {
                console.error(e);
                alert("Error downloading file.");
            } finally {
                // Button wapas normal karein
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>
